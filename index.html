<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>tutto quello che non ti ho detto</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyDkEbGe0jOfT4tdcHeQK7-JM2HNQqYYWiM",
          authDomain: "unsaidletters-7e83f.firebaseapp.com",
          projectId: "unsaidletters-7e83f",
          storageBucket: "unsaidletters-7e83f.firebasestorage.app",
          messagingSenderId: "663621970432",
          appId: "1:663621970432:web:97923664c458a2f4bc46e5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        window.dbFunctions = { db, collection, addDoc, getDocs, query, orderBy };
    </script>
</head>
<body class="bg-slate-50 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { db, collection, addDoc, getDocs, query, orderBy } = window.dbFunctions;

        // Sostituiamo le icone Lucide con Emoji per evitare crash del DOM
        const MailIcon = () => <span style={{fontSize: '24px'}}>‚úâÔ∏è</span>;
        const SendIcon = () => <span style={{fontSize: '20px'}}>‚úàÔ∏è</span>;
        const BackIcon = () => <span style={{fontSize: '20px'}}>‚Üê</span>;

        const FallingLetters = () => {
          const [fallingChars, setFallingChars] = useState([]);
          useEffect(() => {
            const chars = 'abcdefghilmnopqrstuvwxyz'.split('');
            const items = Array.from({ length: 25 }, (_, i) => ({
              id: i, char: chars[Math.floor(Math.random() * chars.length)],
              left: Math.random() * 100, duration: 10 + Math.random() * 10,
              delay: Math.random() * 5, fontSize: 18 + Math.random() * 20
            }));
            setFallingChars(items);
          }, []);
          return (
            <div className="fixed inset-0 overflow-hidden pointer-events-none">
              {fallingChars.map((item) => (
                <div key={item.id} className="absolute text-slate-300 opacity-20 font-serif"
                  style={{ left: `${item.left}%`, fontSize: `${item.fontSize}px`, animation: `fall ${item.duration}s linear ${item.delay}s infinite` }}>
                  {item.char}
                </div>
              ))}
              <style>{`@keyframes fall { 0% { transform: translateY(-100px); opacity: 0; } 10% { opacity: 0.2; } 90% { opacity: 0.2; } 100% { transform: translateY(100vh); opacity: 0; } }`}</style>
            </div>
          );
        };

        const UnsaidLetters = () => {
          const [view, setView] = useState('home');
          const [letters, setLetters] = useState([]);
          const [loading, setLoading] = useState(false);
          const [selectedLetter, setSelectedLetter] = useState(null);
          const [recipient, setRecipient] = useState('');
          const [content, setContent] = useState('');
          const [sender, setSender] = useState('');
          const [showConfirmation, setShowConfirmation] = useState(false);

          useEffect(() => {
            if (view === 'read') loadLetters();
          }, [view]);

          const loadLetters = async () => {
            setLoading(true);
            try {
              const q = query(collection(db, "letters"), orderBy("timestamp", "desc"));
              const querySnapshot = await getDocs(q);
              const docs = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              setLetters(docs);
            } catch (e) { 
              console.error("Errore Firebase:", e);
              // Se l'errore dice "requires an index", clicca il link nella console del browser!
            }
            setLoading(false);
          };

          const submitLetter = async () => {
            if (!recipient.trim() || !content.trim()) return;
            setLoading(true);
            try {
              await addDoc(collection(db, "letters"), {
                recipient: recipient.trim(),
                content: content.trim(),
                sender: sender.trim() || 'Anonimo',
                timestamp: Date.now()
              });
              setRecipient(''); setContent(''); setSender('');
              setShowConfirmation(true);
              setTimeout(() => { setShowConfirmation(false); setView('home'); }, 3000);
            } catch (e) { alert("Errore invio"); }
            setLoading(false);
          };

          if (view === 'home') {
            return (
              <div className="min-h-screen bg-gradient-to-br from-blue-50 via-slate-50 to-blue-100 flex items-center justify-center p-4 relative">
                <FallingLetters />
                <div className="text-center max-w-2xl relative z-10">
                  <h1 className="text-4xl md:text-5xl font-serif text-slate-700 mb-16 leading-tight">tutto quello che non ti ho detto</h1>
                  <div className="flex gap-8 justify-center items-center text-2xl md:text-3xl">
                    <button onClick={() => setView('write')} className="text-slate-700 hover:text-slate-900 font-light underline underline-offset-4">teloscrivoadesso</button>
                    <span className="text-slate-300">\</span>
                    <button onClick={() => setView('read')} className="text-slate-700 hover:text-slate-900 font-light underline underline-offset-4">leggere</button>
                  </div>
                </div>
              </div>
            );
          }

          if (view === 'write') {
            return (
              <div className="min-h-screen p-4 md:p-8">
                <div className="max-w-3xl mx-auto">
                  <button onClick={() => setView('home')} className="text-slate-600 mb-6 flex items-center gap-2"><BackIcon /> Torna indietro</button>
                  {showConfirmation ? (
                    <div className="bg-white rounded-lg shadow-xl p-8 text-center">
                      <div className="text-6xl mb-6">üíå</div>
                      <p className="text-slate-600 text-lg font-light">Messaggio affidato al web.</p>
                    </div>
                  ) : (
                    <div className="bg-white rounded-lg shadow-xl p-8 md:p-12">
                      <input type="text" value={recipient} onChange={(e) => setRecipient(e.target.value)} placeholder="Per..." className="w-full mb-6 p-3 border rounded-lg outline-none focus:ring-2 focus:ring-slate-300" />
                      <textarea value={content} onChange={(e) => setContent(e.target.value)} placeholder="Cosa non hai mai detto?" rows="10" className="w-full mb-6 p-3 border rounded-lg outline-none focus:ring-2 focus:ring-slate-300 resize-none" />
                      <input type="text" value={sender} onChange={(e) => setSender(e.target.value)} placeholder="Da... (opzionale)" className="w-full mb-6 p-3 border rounded-lg outline-none" />
                      <button onClick={submitLetter} disabled={!recipient || !content || loading} className="w-full bg-slate-700 text-white py-4 rounded-lg flex justify-center items-center gap-2 hover:bg-slate-800 disabled:bg-slate-300">
                        <SendIcon /> {loading ? 'Invio...' : 'Invia'}
                      </button>
                    </div>
                  )}
                </div>
              </div>
            );
          }

          if (selectedLetter) {
            return (
              <div className="min-h-screen p-4 md:p-8">
                <div className="max-w-3xl mx-auto">
                  <button onClick={() => setSelectedLetter(null)} className="text-slate-600 mb-6 flex items-center gap-2"><BackIcon /> Torna alle lettere</button>
                  <div className="bg-white rounded-lg shadow-xl p-8">
                    <h2 className="text-3xl font-serif text-slate-700 border-b pb-4 mb-6">Per {selectedLetter.recipient}</h2>
                    <p className="whitespace-pre-wrap text-lg font-light text-slate-600 mb-8">{selectedLetter.content}</p>
                    <div className="text-right text-slate-500 italic">‚Äî {selectedLetter.sender}</div>
                  </div>
                </div>
              </div>
            );
          }

          return (
            <div className="min-h-screen p-4 md:p-8">
              <div className="max-w-6xl mx-auto">
                <button onClick={() => setView('home')} className="text-slate-600 mb-6 flex items-center gap-2"><BackIcon /> Torna indietro</button>
                <h2 className="text-3xl font-serif text-slate-700 mb-8 text-center">Lettere non inviate</h2>
                {loading ? <div className="text-center py-20">Caricamento...</div> : (
                  <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-6">
                    {letters.map((l, i) => (
                      <button key={i} onClick={() => setSelectedLetter(l)} className="aspect-square bg-white rounded-lg shadow hover:shadow-xl transition-all flex flex-col items-center justify-center p-4 border border-slate-100 hover:scale-105">
                        <MailIcon />
                        <p className="mt-2 text-sm text-slate-600 font-light truncate w-full text-center">Per {l.recipient}</p>
                      </button>
                    ))}
                  </div>
                )}
              </div>
            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<UnsaidLetters />);
    </script>
</body>
</html>
